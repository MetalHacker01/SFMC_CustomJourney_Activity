<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Custom Journey Activity Configuration</title>
      <meta name="viewport"
         content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

      <link rel="stylesheet" type="text/css"
         href="/assets/styles/salesforce-lightning-design-system.css">
      <link rel="stylesheet" type="text/css" href="styles.css">
      <style>
        body {
            background-color: #fafaf9;
            font-family: "Salesforce Sans", Arial, sans-serif;
        }
        
        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .config-section {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #3e3e3c;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d8dde6;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1589ee;
            box-shadow: 0 0 0 1px #1589ee;
        }
        
        .btn {
            background-color: #0176d3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #014486;
        }
        
        .btn:disabled {
            background-color: #c9c7c5;
            cursor: not-allowed;
        }
    </style>
   </head>
   <body>
      <div class="container">
         <div class="config-section">
            <h2>Custom Activity Configuration</h2>
            <p>Configure your custom journey activity settings below.</p>

            <div class="form-group">
               <label for="activity-name">Activity Name:</label>
               <input type="text" id="activity-name"
                  placeholder="Enter activity name" value="My Custom Activity">
            </div>

            <div class="form-group">
               <label for="message-text">Message:</label>
               <textarea id="message-text" rows="3"
                  placeholder="Enter your custom message">Hello from custom activity!</textarea>
            </div>

            <div class="form-group">
               <label for="execution-timeout">Execution Timeout (ms):</label>
               <input type="number" id="execution-timeout" value="60000"
                  min="1000" max="100000">
            </div>

            <div class="form-group">
               <label for="retry-count">Retry Count:</label>
               <select id="retry-count">
                  <option value="0">0</option>
                  <option value="1">1</option>
                  <option value="2">2</option>
                  <option value="3">3</option>
                  <option value="4">4</option>
                  <option value="5">5</option>
               </select>
            </div>
         </div>

         <div class="config-section">
            <button id="save-config" class="btn">Save Configuration</button>
            <span id="status-message"
               style="margin-left: 15px; color: #4bca81;"></span>
         </div>
      </div>

      <!-- Postmonger for SFMC Communication -->
      <script
         src="https://sfmc-example-jb-custom-activity.herokuapp.com/vendor/postmonger.js"></script>

      <script>
        // Initialize Postmonger connection
        const connection = new Postmonger.Session();
        
        let activityPayload = {};
        
        // Listen for initialization from Journey Builder
        connection.on('initActivity', function(payload) {
            console.log('Activity initialized:', payload);
            activityPayload = payload;
            
            // Populate form with existing configuration
            if (payload.configurationArguments) {
                const config = payload.configurationArguments;
                
                if (config.activityName) {
                    document.getElementById('activity-name').value = config.activityName;
                }
                if (config.messageText) {
                    document.getElementById('message-text').value = config.messageText;
                }
                if (config.executionTimeout) {
                    document.getElementById('execution-timeout').value = config.executionTimeout;
                }
                if (config.retryCount) {
                    document.getElementById('retry-count').value = config.retryCount;
                }
            }
            
            // Enable save button
            document.getElementById('save-config').disabled = false;
        });
        
        // Handle save button click
        document.getElementById('save-config').addEventListener('click', function() {
            const config = {
                activityName: document.getElementById('activity-name').value,
                messageText: document.getElementById('message-text').value,
                executionTimeout: parseInt(document.getElementById('execution-timeout').value),
                retryCount: parseInt(document.getElementById('retry-count').value)
            };
            
            // Update activity payload
            activityPayload.configurationArguments = config;
            activityPayload.name = config.activityName;
            
            // Define what data to pass to execute endpoint
            activityPayload.arguments.execute.inArguments = [{
                activityName: config.activityName,
                messageText: config.messageText,
                executionTimeout: config.executionTimeout,
                retryCount: config.retryCount,
                contactKey: "{{Contact.Key}}",
                emailAddress: "{{Contact.Attribute.EmailAddress}}"
            }];
            
            // Send configuration back to Journey Builder
            connection.trigger('updateActivity', activityPayload);
            
            // Show success message
            document.getElementById('status-message').textContent = 'Configuration saved!';
            setTimeout(() => {
                document.getElementById('status-message').textContent = '';
            }, 3000);
        });
        
        // Listen for form field changes to enable real-time validation
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('change', function() {
                // You can add validation logic here
                console.log('Configuration changed');
            });
        });
        
        // Initialize connection
        connection.trigger('ready');
        console.log('Custom Activity Config UI loaded');
    </script>
   </body>
</html>