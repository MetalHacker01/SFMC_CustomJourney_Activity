<!DOCTYPE html>
<html lang="en">
   <head>
      <meta charset="utf-8">
      <title>Custom Journey Activity Configuration</title>
      <meta name="viewport"
         content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

      <link rel="stylesheet" type="text/css"
         href="/assets/styles/salesforce-lightning-design-system.css">
      <link rel="stylesheet" type="text/css" href="styles.css">
      <style>
        body {
            background-color: #fafaf9;
            font-family: "Salesforce Sans", Arial, sans-serif;
        }
        
        .container {
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .config-section {
            background: white;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #3e3e3c;
        }
        
        input, textarea, select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d8dde6;
            border-radius: 4px;
            font-size: 14px;
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #1589ee;
            box-shadow: 0 0 0 1px #1589ee;
        }
        
        .btn {
            background-color: #0176d3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn:hover {
            background-color: #014486;
        }
        
        .btn:disabled {
            background-color: #c9c7c5;
            cursor: not-allowed;
        }
    </style>
   </head>
   <body>
      <div class="container">
         <div class="config-section">
            <h2>Data Extension Update Activity</h2>
            <p>This activity will update the <strong>CustomText</strong> field in your entry source data extension with a custom message.</p>
            
            <div class="form-group">
               <label for="activity-name">Activity Name:</label>
               <input type="text" id="activity-name"
                  placeholder="Enter activity name" value="Update CustomText Field">
            </div>

            <div class="form-group">
               <label for="message-text">Custom Message for CustomText Field:</label>
               <textarea id="message-text" rows="3" required
                  placeholder="Enter the message to write to the CustomText field">Contact processed by custom journey activity</textarea>
               <small style="color: #666;">This message will be written to the CustomText field in the Master_Subscriber data extension.</small>
            </div>
            
            <div class="form-group">
               <label>Target Data Extension:</label>
               <p style="margin: 5px 0; padding: 10px; background: #f4f6f9; border-radius: 4px; font-family: monospace;">
                  <strong>Name:</strong> Master_Subscriber<br>
                  <strong>External Key:</strong> 3010F472-DE73-4A74-BB75-5FD96D878E75<br>
                  <strong>Field to Update:</strong> CustomText
               </p>
            </div>
         </div>

         <div class="config-section">
            <p><strong>Note:</strong> Click "Done" in Journey Builder to save your configuration.</p>
            <span id="status-message" style="color: #4bca81;"></span>
         </div>
      </div>

      <!-- Postmonger for SFMC Communication -->
      <script
         src="https://cdn.jsdelivr.net/npm/postmonger@0.0.16/postmonger.min.js"></script>
      <script>  
      // Initialize Postmonger connection
        const connection = new Postmonger.Session();
        
        let activityPayload = {};
        
        // Listen for initialization from Journey Builder
        connection.on('initActivity', function(payload) {
            console.log('Activity initialized:', payload);
            activityPayload = payload;
            
            // Populate form with existing configuration
            if (payload.arguments && payload.arguments.execute && payload.arguments.execute.inArguments && payload.arguments.execute.inArguments.length > 0) {
                const inArgs = payload.arguments.execute.inArguments[0];
                
                if (inArgs.customMessage) {
                    document.getElementById('message-text').value = inArgs.customMessage;
                }
            }
            
            // Tell Journey Builder we're ready and enable the Done button
            connection.trigger('updateButton', { button: 'next', enabled: true });
            
            document.getElementById('status-message').textContent = 'Configuration loaded successfully';
            setTimeout(() => {
                document.getElementById('status-message').textContent = '';
            }, 2000);
        });
        
        // Listen for when Journey Builder wants to save (Done button clicked)
        connection.on('clickedNext', function() {
            save();
        });
        
        // Save function - called when Done is clicked
        function save() {
            const customMessage = document.getElementById('message-text').value || 'Default custom message';
            
            // Update the activity payload with our configuration
            activityPayload.name = document.getElementById('activity-name').value || 'Custom Data Extension Update';
            
            // Set the arguments that will be passed to the execute endpoint
            activityPayload.arguments.execute.inArguments = [{
                contactKey: "{{Contact.Key}}",
                emailAddress: "{{InteractionDefaults.Email}}",
                customMessage: customMessage
            }];
            
            // Mark as configured
            activityPayload.metaData.isConfigured = true;
            
            // Send the updated activity back to Journey Builder
            connection.trigger('updateActivity', activityPayload);
            
            console.log('Activity configuration saved:', activityPayload);
        }
        
        // Listen for form field changes to validate in real-time
        document.querySelectorAll('input, textarea, select').forEach(element => {
            element.addEventListener('input', function() {
                // Enable/disable Done button based on validation
                const messageText = document.getElementById('message-text').value;
                const isValid = messageText.trim().length > 0;
                
                connection.trigger('updateButton', { 
                    button: 'next', 
                    enabled: isValid 
                });
            });
        });
        
        // Initialize connection
        connection.trigger('ready');
        console.log('Custom Activity Config UI loaded');
    </script>
   </body>
</html>